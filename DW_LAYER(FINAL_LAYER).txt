create or replace TABLE DATA_WAREHOUSING.DW.CUSTOMER_DIM (
    CUSTOMER_KEY INT IDENTITY(1,1),
	CUSTOMER_ID NUMBER(38,0),
	CUSTOMER_NAME VARCHAR(255),
	USERNAME VARCHAR(255),
	SEGMENT VARCHAR(255),
	POSTAL_CODE VARCHAR(20),
	CITY VARCHAR(255),
	STATE VARCHAR(255),
	REGION VARCHAR(255),
	COUNTRY VARCHAR(255)
);
-- FIRST LOAD --
INSERT INTO CUSTOMER_DIM(CUSTOMER_ID, CUSTOMER_NAME, USERNAME, SEGMENT, POSTAL_CODE, CITY, STATE, REGION, COUNTRY)
SELECT * FROM STAGE.STG_CUSTOMERS

-- INCREMENTAL LOAD --

-- UPDATE QUERY --
UPDATE CUSTOMER_DIM
SET SEGMENT = STG_CUSTOMERS.SEGMENT, POSTAL_CODE = STG_CUSTOMERS.POSTAL_CODE
FROM STAGE.STG_CUSTOMERS WHERE STG_CUSTOMERS.CUSTOMER_ID = CUSTOMER_DIM.CUSTOMER_ID

-- INSERT QUERY--
INSERT INTO CUSTOMER_DIM(CUSTOMER_ID, CUSTOMER_NAME, USERNAME, SEGMENT, POSTAL_CODE, CITY, STATE, REGION, COUNTRY)
SELECT * FROM STAGE.STG_CUSTOMERS WHERE CUSTOMER_ID NOT IN (
SELECT CUSTOMER_ID FROM CUSTOMER_DIM)

SELECT * FROM CUSTOMER_DIM

-------------------------------------------------------------------

create or replace TABLE DATA_WAREHOUSING.DW.PRODUCT_DIM (
    PRODUCT_KEY INT IDENTITY(1,1),
	PRODUCT_ID NUMBER(38,0),
	PRODUCT_NAME VARCHAR(255),
	PRICE NUMBER(6,2),
	SUB_CATEGORY VARCHAR(255),
	CATEGORY VARCHAR(255),
    EFFECTIVE_DATE DATE,
    END_DATE DATE
);

-- FIRST LOAD --
INSERT INTO DATA_WAREHOUSING.DW.PRODUCT_DIM(PRODUCT_ID, PRODUCT_NAME, PRICE, SUB_CATEGORY, CATEGORY, EFFECTIVE_DATE, END_DATE)
SELECT *,
CURRENT_DATE - 1 AS EFFECTIVE_DATE, '9999-12-31'::DATE AS END_DATE
FROM STAGE.STG_PRODUCTS

-- INCREMENTAL LOAD --

-- UPDATE QUERY --
UPDATE PRODUCT_DIM
SET END_DATE = CURRENT_DATE +1
FROM STAGE.STG_PRODUCTS
WHERE PRODUCT_DIM.PRODUCT_ID = STG_PRODUCTS.PRODUCT_ID AND PRODUCT_DIM.END_DATE = '9999-12-31'

-- INSERT QUERY --
INSERT INTO PRODUCT_DIM (PRODUCT_ID, PRODUCT_NAME, PRICE, SUB_CATEGORY, CATEGORY, EFFECTIVE_DATE, END_DATE)
SELECT *, CURRENT_DATE+2 AS EFFECTIVE_DATE, '9999-12-31'::DATE AS END_DATE FROM STAGE.STG_PRODUCTS

SELECT * FROM DATA_WAREHOUSING.DW.PRODUCT_DIM
--------------------------------------------------------------------

create or replace TABLE DATA_WAREHOUSING.DW.FCT_ORDERS (
	ORDER_ID NUMBER(38,0),
	ORDER_NUMBER VARCHAR(255),
	ORDER_DATE DATE,
	CUSTOMER_KEY NUMBER(38,0),
	DISCOUNT NUMBER(6,2),
	PRODUCT_KEY NUMBER(38,0),
	QUANTITY NUMBER(38,0),
	SALES NUMBER(8,2)
);

INSERT INTO DATA_WAREHOUSING.DW.FCT_ORDERS 
SELECT O.ORDER_ID, O.ORDER_NUMBER, O.ORDER_DATE, CD.CUSTOMER_KEY, O.DISCOUNT, PD.PRODUCT_KEY, O.QUANTITY, O.SALES
FROM STAGE.STG_ORDERS O
INNER JOIN DW.PRODUCT_DIM PD ON PD.PRODUCT_ID = O.PRODUCT_ID AND PD.END_DATE = '9999-12-31'
INNER JOIN DW.CUSTOMER_DIM CD ON CD.CUSTOMER_ID = O.CUSTOMER_ID

SELECT * FROM FCT_ORDERS



--DATE_DIM--
INSERT INTO CALENDER_DIM
WITH RECURSIVE CTE AS (
  SELECT '2000-01-01'::DATE AS CAL_DATE
  UNION ALL
  SELECT CAL_DATE + 1 AS CAL_DATE
  FROM CTE
  WHERE CAL_DATE + 1 <= '2050-12-31'
)
SELECT CAL_DATE, YEAR(CAL_DATE)AS CAL_YEAR, MONTH(CAL_DATE) AS CAL_MONTH FROM CTE;

CREATE OR REPLACE TABLE CALENDER_DIM(
CAL_DATE DATE ,
CAL_YEAR VARCHAR(4),
CAL_MONTH VARCHAR(2)
)

SELECT * FROM CALENDER_DIM
